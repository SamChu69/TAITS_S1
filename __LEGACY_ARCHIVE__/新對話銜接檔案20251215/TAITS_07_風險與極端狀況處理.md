# 📘 TAITS_07_風險與極端狀況處理.md

（Risk & Extreme Handling｜**可否決一切**｜恐慌/斷線/熔斷/資料錯誤/黑天鵝/你不在場時保命｜API-first｜可直接存 GitHub）

---

## 0. 文件定位（最高否決權）

本文件是 TAITS 的 **最高否決層（Hard Stop Layer）**，定義：

* 任何策略、任何治理決策、任何交易意圖
  **在什麼條件下必須被阻擋、降級或停機**
* 在極端行情、資料異常、API 斷線、政策衝擊、突發事件時
  TAITS 如何「先保命、再求勝率」
* 你不在電腦前、或系統誤判時
  TAITS 如何**自我收斂**，避免災難性損失

嚴格定位：

* ✅ Risk/Compliance 可否決一切（含 Regime、策略、治理、執行）
* ✅ TAITS 預設：**寧可錯過，不可爆倉/不可失控**
* ✅ 本層與 03O/03S/券商 API 強耦合（保證落地）

---

## 1. 世界一流內部評分標準（10/10 必要條件）

1. **硬條件可機械執行**：每條風控都能轉成條件判斷，不是口號
2. **分級清楚**：警示/降級/阻擋/停機（四級）
3. **全鏈路覆蓋**：資料→策略→治理→送單→成交→持倉→復原
4. **極端場景完整**：恐慌、熔斷、斷線、跳空、流動性蒸發、結算、追繳
5. **你不在場也安全**：Auto 必須能自動降級、凍結新倉
6. **可審計可回放**：任何風控觸發都有證據包與版本鎖
7. **不與策略混層**：風控不產生 alpha，只做否決與限制
8. **容錯與復原**：失敗後怎麼回到安全狀態（Fail-safe）
9. **台灣市場特性**：漲跌停、零股、撮合、夜盤資訊、結算壓力
10. **可演進**：新增風控項不破壞既有策略與治理

---

## 2. 風控的四級輸出（Risk Action Levels）

TAITS 所有風險事件都必須落在四級之一：

* **R0：OBSERVE（觀察）**
  只記錄，不限制交易（但可提示）
* **R1：DEGRADE（降級）**
  降到 L1（只建議）或 L2（小額意圖），縮小風險預算
* **R2：BLOCK（阻擋）**
  阻擋新倉/新意圖，允許管理既有倉位（減碼/停損/停利）
* **R3：KILL-SWITCH（停機）**
  立即停止所有新行為；必要時只允許「風控出場」或「全部凍結」

---

## 3. 風控覆蓋範圍（必須全包）

### 3.1 Data Risk（資料風險）

* 官方資料延遲/缺漏/異常值
* 多來源不一致
* API Rate limit / 斷線 / 超時
* 時間戳錯亂（時區、交易日）

### 3.2 Market Risk（市場風險）

* 高波動、恐慌、跳空、漲跌停連鎖
* 流動性蒸發、滑價暴增
* 集中度風險、題材泡沫
* 期貨/選擇權/融資融券壓力（觀察層）

### 3.3 Model Risk（模型/策略風險）

* 多策略互打
* 過擬合徵兆
* 新題材/新制度造成失效
* 置信度崩壞（信號不穩）

### 3.4 Execution Risk（執行風險）

* 券商 API 不穩、回報不一致
* 下單重複、成交回報延遲
* 部分成交、掛單卡住
* 交易成本超預期

### 3.5 Operational Risk（營運/人為風險）

* 你不在場
* 系統重啟、更新、參數誤改
* 密碼/Token 過期
* 時間表錯誤（休市、颱風假）

---

## 4. Risk Engine 核心輸入/輸出（落地級）

### 4.1 RiskInputs

* `regime_state`（TAITS_04）
* `market_snapshot`（波動、廣度、流動性）
* `derivatives_observation`（FU/OP/MG/EV）
* `portfolio_state`（持倉、曝險、回撤）
* `execution_health`（API/回報/延遲）
* `data_health`（缺漏/一致性/延遲）
* `governance_state`（當前允許等級 L0~L4）

### 4.2 RiskOutputs

* `risk_action_level`（R0~R3）
* `allowed_governance_cap`（上限：L0~L4）
* `risk_budget_multiplier`（0~1）
* `hard_constraints[]`（禁止追價/強制分批/禁止加碼/禁止隔夜等）
* `kill_switch_reason[]`（中文原因）
* `audit_bundle`（證據包）

---

## 5. 硬風控規則全集（不可少，按優先序）

> 任何一條命中都可以觸發 R2/R3。
> 你要最完整，因此我把硬規則分 10 組（本批先交付 1~5 組；下一批交付 6~10 組，確保完整且不漏）

---

### 5A. 資料健康 Hard Rules（DR 系列）

* **DR-01_官方來源缺漏**：官方 API 缺主要欄位或連續缺資料 → R2（BLOCK 新倉）
* **DR-02_多來源不一致**：同一字段差異超過門檻（例：收盤價、成交量）→ R1（DEGRADE）
* **DR-03_時間戳錯亂**：資料時間逆行或跨交易日錯置 → R2
* **DR-04_延遲超標**：即時資料延遲超過門檻 → R1/R2（依程度）
* **DR-05_異常值爆點**：價格/量突然跳異常且未被其他來源確認 → R2
* **DR-06_資料來源切換保護**：主源→備援切換時強制 L1 → R1

---

### 5B. API/執行健康 Hard Rules（EX 系列）

* **EX-01_API 斷線**：券商 API 斷線或認證失敗 → R3（KILL-SWITCH）
* **EX-02_回報不一致**：下單回報與成交回報不一致 → R2
* **EX-03_重複下單風險**：同一意圖可能重送 → R3
* **EX-04_延遲爆表**：回報延遲超標 → R2
* **EX-05_部分成交卡住**：部分成交 + 無法撤單 → R2（僅允許風控處置）
* **EX-06_成本超預期**：03O 預估成本與實際偏差超標 → R1/R2

---

### 5C. 市場恐慌/高波 Hard Rules（MK 系列）

* **MK-01_恐慌狀態 R5**：Regime=R5 → R2（BLOCK 新倉）
* **MK-02_高波動鎖定**：Regime=R4 且波動指標超門檻 → R1（降級）
* **MK-03_跳空風險**：重大跳空 + 流動性不足 → R2
* **MK-04_漲跌停連鎖**：標的或族群連續極端 → R2
* **MK-05_流動性蒸發**：成交額/委買委賣深度急降 → R2/R3
* **MK-06_市場廣度崩壞**：多數標的同步惡化 → R1/R2

---

### 5D. 集中度與題材泡沫 Hard Rules（CN 系列）

* **CN-01_單一標的曝險上限**：超過上限 → R2（禁止新加碼）
* **CN-02_單一題材曝險上限**：超過上限 → R1（整體降權）
* **CN-03_單一族群曝險上限**：超過上限 → R1
* **CN-04_中小型股過度集中**：小型股占比超標 → R1/R2
* **CN-05_題材過熱**：TH/EV 同時過熱且波動放大 → R1（降級 + 禁追）

---

### 5E. 衍生品/信用壓力 Hard Rules（DV 系列；觀察用但可否決）

* **DV-01_期貨避險升高**：FU 顯示避險盤升高 → R1（降級）
* **DV-02_期現價差異常擴大**：Basis 異常 → R1（禁追價）
* **DV-03_結算壓力**：結算前壓力旗標 → R1/R2
* **DV-04_選擇權 Gamma 風險**：OP 顯示 Gamma 擠壓 → R2（禁止新倉）
* **DV-05_最大痛點鎖價**：Pinning 明顯 → R1（僅短線/觀察）
* **DV-06_融資追繳風險**：MG 顯示追繳風險升高 → R2（降到 L1 或封新倉）

---

## 6. 風控與治理的對齊（你要「你不在場也安全」）

### 6.1 Risk Cap 規則（硬上限）

風控輸出 `allowed_governance_cap`，直接封頂治理層：

* Risk=R0 → cap = L4（看你是否開 Auto）
* Risk=R1 → cap = L2（最多小額意圖）
* Risk=R2 → cap = L1（只建議，禁止新倉）
* Risk=R3 → cap = L0（只觀察 + 風控處置）

### 6.2 「你不在場」保護（Operator Away Mode）

若你設定 Away 或系統偵測到你未確認：

* 自動把 cap 下修一級（例如 L2→L1）
* 所有新增意圖變成 Suggest
* 仍保留風控出場能力

---

## 7. 審計與可回放（新對話一定能理解）

每一次風控觸發必留下：

* `risk_rule_id`（例如 EX-01）
* `risk_action_level`（R0~R3）
* `cap_level`（L0~L4）
* `evidence_bundle`（資料延遲/波動/成本/觀察層）
* `human_override`（你是否手動解除）
* `version`（TAITS_07.x）

---

## 8. 本批交付範圍聲明（07 第一批）

本批已完整交付 10 組硬風控中的 **1~5 組**：

1. DR（資料健康）
2. EX（API/執行健康）
3. MK（市場恐慌/高波）
4. CN（集中度/題材泡沫）
5. DV（衍生品/信用壓力）

---

## 9. 世界一流品質鎖定（本批的完成定義）

本批完成 **07 的最後 50%**，補齊你指定的 **6～10 組硬風控**，使 TAITS 在任何極端情況下都能：

* **先停、再想、可回復**
* **你不在場也不會亂動**
* **每個動作都有回放與證據**

> 到此為止，TAITS 的風控是「工程化防災系統」，不是口頭風險管理。

---

## 10. 硬風控第 6 組：PR（Portfolio / Drawdown / Exposure）

> **目的**：避免「單一錯誤 → 全系統毀滅」

### PR 系列（硬規則）

* **PR-01_組合回撤軟門檻**
  條件：近 N 日回撤 ≥ 軟門檻
  動作：R1（DEGRADE），cap=L2

* **PR-02_組合回撤硬門檻**
  條件：近 N 日回撤 ≥ 硬門檻
  動作：R2（BLOCK 新倉），僅允許減碼/停損

* **PR-03_單日損失上限**
  條件：單日 PnL ≤ -X%
  動作：R2，封新倉

* **PR-04_連續虧損天數**
  條件：連續虧損 ≥ K 日
  動作：R1→R2（依程度）

* **PR-05_曝險集中超標**
  條件：單一標的/題材/族群曝險超標
  動作：R1（整體降權）

* **PR-06_槓桿/名目曝險異常**
  條件：名目曝險突增
  動作：R2（禁止加碼）

* **PR-07_中小型股曝險偏高**
  條件：Small-cap lane 超配
  動作：R1（降權但不清倉）

* **PR-08_隔夜曝險風險**
  條件：隔夜風險旗標升高
  動作：R1（禁止新隔夜）

---

## 11. 硬風控第 7 組：MD（Model / Overfitting / Confidence）

> **目的**：防止「模型自己騙自己」

### MD 系列（硬規則）

* **MD-01_信號一致性崩壞**
  條件：多策略分歧過大
  動作：R1（降權）

* **MD-02_置信度衰退**
  條件：平均 confidence 連續下降
  動作：R1

* **MD-03_回測/實盤偏差**
  條件：實盤表現顯著偏離回測
  動作：R2（封新倉）

* **MD-04_新策略冷啟動保護**
  條件：新策略樣本不足
  動作：R1（只建議）

* **MD-05_過擬合警示**
  條件：參數敏感度過高
  動作：R2（停用該策略族）

* **MD-06_資料分布轉移**
  條件：市場分布變化（Regime Shift）
  動作：R1→R2

* **MD-07_模型版本未鎖定**
  條件：版本不一致
  動作：R2（阻擋）

---

## 12. 硬風控第 8 組：OPX（Operational / Schedule / Human）

> **目的**：防止「不是市場的錯，而是操作的錯」

### OPX 系列（硬規則）

* **OPX-01_交易日曆錯誤**
  條件：休市/半日市未正確載入
  動作：R3（KILL）

* **OPX-02_颱風/臨時休市**
  條件：官方公告
  動作：R3（停機）

* **OPX-03_排程錯誤**
  條件：策略在非預期時間啟動
  動作：R2

* **OPX-04_設定檔異常變更**
  條件：未授權變更
  動作：R3

* **OPX-05_Token/金鑰過期**
  條件：API 認證失效
  動作：R3

* **OPX-06_你不在場（Away Mode）**
  條件：未確認在場
  動作：cap 下修一級

---

## 13. 硬風控第 9 組：REC（Recovery / Resume）

> **目的**：回答你最關鍵的問題之一
> **「停下來之後，怎麼恢復？」**

### REC 系列（硬規則）

* **REC-01_自動恢復禁止**
  原則：R2/R3 後 **不得自動回到 Auto**

* **REC-02_資料健康恢復條件**
  條件：資料連續穩定 ≥ T
  動作：允許 R2→R1

* **REC-03_市場穩定確認**
  條件：波動/流動性回到正常
  動作：允許 R1→R0

* **REC-04_人工確認必要**
  條件：任何 KILL 事件
  動作：必須人工解除

* **REC-05_分階段恢復**
  流程：Observe → Suggest → Intent → Auto（逐步）

* **REC-06_恢復冷卻期**
  條件：恢復後 N 期內禁止全倉

---

## 14. 硬風控第 10 組：KILL（Kill-Switch / Exit-Only）

> **目的**：最後一道牆，**不討論 alpha**

### KILL 系列（最高優先）

* **KILL-01_全域停機**
  條件：EX-01 / OPX-01 / OPX-02
  動作：R3，立即停機

* **KILL-02_只允許風控出場**
  條件：KILL 狀態
  動作：只允許減碼/停損

* **KILL-03_禁止新指令**
  條件：R3
  動作：所有新 Intent 直接丟棄

* **KILL-04_人工解除必須審計**
  條件：任何解除
  動作：強制填寫原因

* **KILL-05_重啟後鎖定**
  條件：系統重啟
  動作：預設回到 L0（Observe）

---

## 15. 風控 × 治理 × 執行 的最終對齊（總表）

| Risk Level | Governance Cap | 新倉 | 加碼 | 風控出場  | Auto |
| ---------- | -------------- | -- | -- | ----- | ---- |
| R0         | L4             | ✓  | ✓  | ✓     | ✓    |
| R1         | L2             | △  | ✕  | ✓     | ✕    |
| R2         | L1             | ✕  | ✕  | ✓     | ✕    |
| R3         | L0             | ✕  | ✕  | ✓（必要） | ✕    |

---

## 16. 審計輸出（固定格式，不得省略）

```json
{
  "risk_rule": "PR-02",
  "risk_action": "R2",
  "governance_cap": "L1",
  "trigger_time": "2025-12-15T10:32:00+08:00",
  "evidence": ["drawdown_exceeded", "volatility_spike"],
  "auto_recovery_allowed": false,
  "manual_override": false,
  "version": "TAITS_07.2"
}
```

---

## 17. TAITS_07 完整收官聲明

* ✔ 10 組硬風控 **全部交付（1～10）**
* ✔ 覆蓋：資料 / 市場 / 模型 / 組合 / 執行 / 人為 / 復原 / 停機
* ✔ **Risk/Compliance 可否決一切**
* ✔ 你不在場也安全
* ✔ 可審計、可回放、可落地

**TAITS_07 到此完整鎖定。**
