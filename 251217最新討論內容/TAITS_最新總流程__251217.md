# TAITS_最新總流程__251217.md

> doc_key：FLOW_LATEST  
> 治理等級：A（Flow Canon）  
> 適用範圍：STOCK（股票）/ odd_lot（零股）優先  
> 狀態：ACTIVE（Working Canon｜Only-Add）

---

## 0. 本文件定位

本文件描述 TAITS 目前的「端到端總流程」與每一段的責任邊界，確保：

- 策略不碰執行
- 執行不繞過風控
- 任何行為都可回放與審計

---

## 1. 全局流程總覽（End-to-End）

### Stage 0｜System Bootstrap（系統啟動）
- 載入治理設定（Scope Freeze、啟用交易單位、啟用模式）
- 載入產品模組：STOCK_Product
- 初始化 Log 系統與 Correlation ID（關聯追蹤編號）

輸出：
- `SystemContext`

---

### Stage 1｜Data Ingestion（資料擷取）
- 依資料源策略擷取（官方/券商/行情/基本面等）
- 產生 Raw → Normalized → Snapshot

輸出：
- `MarketSnapshot`（可回放）

必備 Log：
- Data Ingestion Log（含來源、時間戳、版本）

---

### Stage 2｜Feature & Regime（特徵與市場狀態）
- 由 Feature Pipeline 產生策略可用特徵
- 由 Regime Engine 判斷市場狀態（例如：趨勢/盤整/高波動等）

輸出：
- `FeatureBundle`
- `RegimeState`

必備 Log：
- Regime Decision Log（可簡化，但要能追溯）

---

### Stage 3｜Strategy Evaluation（策略評估）
- 策略讀取 Snapshot/Features/Regime
- 產生 StrategyIntent（交易意圖）

輸出：
- `StrategyIntent[]`（多策略可擴充，現階段可先單策略）

必備 Log：
- Decision Log（策略輸出、理由、引用特徵摘要）

---

### Stage 4｜Risk/Compliance Gate（風控合規閘門）
- 讀取：
  - StrategyIntent
  - SystemContext（啟用狀態）
  - RegimeState
  - MarketStatus（市場/API 狀態）
- 產生 RiskDecision：
  - ALLOW / DEGRADED / VETO / PAUSE / DISABLE

輸出：
- `RiskDecision[]`（對每個意圖裁決）

必備 Log：
- Risk Decision Log（含 reason_codes）

---

### Stage 5｜Execution Planning（執行規劃）
Execution 在此階段做「承接與轉換」，但不得越權。

#### 5.1 Trade Unit Routing Gate（交易單位路由閘門）
- 檢查策略宣告的 supported_trade_units 是否包含 odd_lot
- 檢查 SystemContext 是否允許 odd_lot
- 若涉及 full_lot/hybrid 必須拒絕（目前未啟用）

#### 5.2 Order Abstraction（委託抽象）
- 把意圖轉成委託計畫（OrderPlan）
- 不寫死券商細節（券商差異在 Adapter）

輸出：
- `OrderPlan[]`

必備 Log：
- Execution Plan Log（可回放）

---

### Stage 6｜Order Execution（委託執行）
- 透過 Broker Adapter（券商介面/適配器）進行：
  - 下單
  - 回報
  - 成交/部分成交
  - 失敗重試（僅限安全範圍；不得自動重試「實盤危險行為」）

輸出：
- `ExecutionResult[]`

必備 Log：
- Execution Log（含 request/response 摘要，不可洩漏憑證）

---

### Stage 7｜Unified Exit & Lifecycle（統一出場與生命週期）
- 出場由 Execution 統一處理（避免 odd/full/hybrid 互踩；雖然目前只啟用 odd_lot）
- 策略生命週期狀態：
  - DRAFT / TESTED / ENABLED / PAUSED / RETIRED

必備 Log：
- Exit Log
- Lifecycle Log

---

### Stage 8｜Explainability Summary（可解釋摘要）
- 產生 Decision Summary（不影響決策）
- 用於人類回顧、審計、AI 分析摘要

輸出：
- `DecisionSummary`

---

## 2. 失敗處理（Failure Handling）

### 2.1 Data Failure（資料失敗）
- 行為：停止策略評估或降級至保守模式（例如 SKIP）
- 不得：用不完整資料強行下單
- 必須：記錄來源、缺失欄位、時間範圍

### 2.2 API Degraded（券商 API 劣化）
- 行為：Risk 可 PAUSE；Execution 停止委託
- 必須：記錄錯誤碼、重試次數（安全範圍內）、人工介入需求

### 2.3 Market Halted（市場停止/特殊狀態）
- 行為：禁止委託
- 必須：記錄事件與來源

---

## 3. Gate 一覽（最重要的防線）

- Scope Freeze Gate：只允許 STOCK + odd_lot（現階段）
- Strategy Meta Gate：新策略必須含 meta（前進式）
- Trade Unit Compatibility Gate：策略不支援 odd_lot → 拒絕
- Enable Gate（full_lot/hybrid）：未啟用 → 拒絕
- Risk Veto Gate：任何階段可否決
- Audit Gate：無 log → 視為未發生（禁止黑箱）

---

（End）
