# TAITS_最新總流程__251217.md

> doc_key：MASTER_FLOW_CANON  
> 流程等級：A（全系統流程｜不可推翻）  
> 適用範圍：TAITS 全系統  
> 狀態：ACTIVE（Canonical Flow｜Only-Add）

---

## 0. 文件定位（Flow Canon）

本文件定義 **TAITS 的端到端（End-to-End）系統流程**，  
從「資料進來」到「交易是否被執行」，  
以及「任何一步出問題時，系統如何停止、記錄、回放」。

📌 本文件為 **架構的行為化版本**，  
所有實作、策略、回測、模擬 **不得違反此流程順序與 Gate 定義**。

---

## 1. 全流程總覽（High-Level Flow）

```text
[ Data Ingestion ]
        ↓
[ Feature Engineering ]
        ↓
[ Strategy Intent Generation ]
        ↓
[ Regime Evaluation ]
        ↓
[ Risk / Compliance Gate ]
        ↓
[ Execution Orchestration ]
        ↓
[ Portfolio / Capital Update ]
        ↓
[ Audit / Logging / Replay ]
📌 任一階段失敗，流程立即停止，不得跳關。

2. 流程共通原則（適用所有模式）
2.1 單向流程原則
流程只能往下走

不允許反向影響已完成階段

2.2 Gate 優先原則
所有 Gate（特別是 Risk）皆有否決權

被否決的 Intent 不得重試為另一型態交易

2.3 完整記錄原則
每一階段都必須產生日誌

沒有 Log = 沒有發生

3. Data Ingestion Flow（資料進入）
輸入

官方市場資料

券商回傳資料

事件 / 制度資料

處理

時間戳記

資料版本標註

原始資料只讀存放

失敗處理

中斷流程

記錄來源與錯誤

不自動重試實盤行為

4. Feature Engineering Flow（特徵處理）
處理

計算技術 / 統計特徵

正規化、標準化

Feature 版本化

限制

不包含策略邏輯

不根據結果調整輸入資料

5. Strategy Intent Generation Flow（策略意圖）
輸入

Feature

Regime Context（只讀）

輸出

StrategyIntent

方向（BUY / SELL / HOLD）

信心或權重

理由摘要

支援交易單位宣告

限制

不得下單

不得否決

不得指定價格

6. Regime Evaluation Flow（市場狀態）
輸入

市場特徵

波動 / 趨勢 / 事件

輸出

Regime 狀態標籤

供 Strategy / Risk 參考

限制

不直接影響下單

不生成交易方向

7. Risk / Compliance Gate（關鍵否決點）
輸入

StrategyIntent

Regime

當前曝險 / 資金狀態

裁決

ALLOW

DENY

DOWNGRADE

PAUSE

原則

Runtime 否決權

一旦否決，流程終止

不允許策略繞過或重包裝

8. Execution Orchestration Flow（執行編排）
前提

僅處理 ALLOW 的 Intent

處理

Trade Unit Routing（odd_lot 為預設）

券商 API 適配（富邦 TradeAPI）

下單嘗試（不保證成交）

失敗

記錄失敗原因

不自動升級交易單位

不重試為不同產品

9. Portfolio / Capital Update（資金更新）
處理

更新持倉

更新可用資金

更新曝險

限制

不影響已完成交易

受 Risk 約束

10. Audit / Logging / Replay（審計回放）
必備 Log

Data Ingestion Log

Strategy Decision Log

Risk Decision Log

Execution Log

要求

correlation_id 串接全流程

可回放

可解釋

11. 失敗與中斷總則
任一階段失敗 → 流程中止

不自動補救實盤行為

必須留下完整狀態

12. 流程最終宣告
TAITS 的流程不是為了「多跑幾筆」，
而是為了「每一筆都能被追溯」。

（End of MASTER_FLOW_CANON）
